#!/bin/bash

HTML_FILE="${1:-spec/fixtures/profile_test.html}"

if [[ ! -f "$HTML_FILE" ]]; then
    echo "Error: HTML file not found: $HTML_FILE"
    exit 1
fi

if ! readelf -S lib/himg/himg.so 2>/dev/null | grep -q "\.debug_info"; then
    echo "Error: No debug symbols found in lib/himg/himg.so"
    echo "Build with: RB_SYS_CARGO_PROFILE=profiling rake compile"
    exit 1
fi

PERF_DATA=$(mktemp /tmp/himg-perf.XXXXXX.data)
RUBY_SCRIPT=$(mktemp /tmp/himg-profile.XXXXXX.rb)
RUBY_COMMAND=$(bundle exec which ruby)

cat > "$RUBY_SCRIPT" << EOF
require 'himg'

html = File.read('$HTML_FILE')

10.times do
  Himg.render(html, disable_fetch: true)
end
EOF

LOAD_PATH='lib' perf record -g --call-graph=dwarf -o "$PERF_DATA" $RUBY_COMMAND "$RUBY_SCRIPT"

rm -f "$RUBY_SCRIPT"

if command -v hotspot &> /dev/null; then
    nohup hotspot "$PERF_DATA" > /dev/null 2>&1 &
else
    echo "Install hotspot to view profile: $PERF_DATA"
fi
